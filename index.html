<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>TechnikerDropdown Widget</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    select { width: 100%; padding: 8px; font-size: 14px; }
  </style>
</head>
<body>
  <label for="technikerDropdown">Techniker auswählen:</label>
  <select id="technikerDropdown"></select>

  <!-- JotForm-Communicator laden -->
  <script src="https://cdn.jsdelivr.net/npm/jotform-custom-widget@1.3.0/lib/iframeCommunicator.js"></script>
  <script>
    (function() {
      let config = {};

      try {
        // 1) Roh‑Parameter aus dem iFrame-Attribut holen
        const raw = window.frameElement?.getAttribute('data-params') || '';
        // 2) URL‑decode, falls nötig
        const jsonString = decodeURIComponent(raw);
        // 3) JSON parsen
        config = JSON.parse(jsonString);
        console.log("Widget-Konfiguration:", config);
      } catch (e) {
        console.error("Fehler beim Parsen der Widget-JSON:", e);
      }

      // 4) Werte extrahieren
      const items = Array.isArray(config.data?.items)
        ? config.data.items.map(i => i.toString())
        : [];
      const def = config.data?.default?.toString() || '';

      // 5) Dropdown füllen
      const dropdown = document.getElementById('technikerDropdown');
      items.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.text  = name;
        if (name === def) opt.selected = true;
        dropdown.appendChild(opt);
      });

      // 6) Auswahl zurück an Jotform senden
      dropdown.addEventListener('change', () => {
        JFCustomWidget.sendData({ value: dropdown.value });
      });
      // initialen Wert senden
      JFCustomWidget.sendData({ value: dropdown.value });

      // 7) Widget-Höhe anpassen
      JFCustomWidget.subscribe('ready', () => {
        JFCustomWidget.setHeight(document.body.scrollHeight);
      });
    })();
  </script>
</body>
</html>
