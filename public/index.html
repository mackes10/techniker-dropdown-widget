<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Techniker‑Dropdown</title>
  <style>
    body { font-family: Arial, sans‑serif; padding: 10px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    select { width: 100%; padding: 8px; font-size: 14px; }
  </style>
</head>
<body>
  <label for="techSelect">Techniker auswählen:</label>
  <select id="techSelect">
    <option value="" disabled>Lade…</option>
  </select>

  <script src="https://cdn.jsdelivr.net/npm/jotform-custom-widget@1.3.0/lib/iframeCommunicator.js"></script>
  <script>
    (function(){
      // 1) Parameter aus Jotform (Key-Value-Pair) lesen
      let raw = window.frameElement?.getAttribute('data-widget-params') || '[]';
      let kv;
      try { kv = JSON.parse(decodeURIComponent(raw)); }
      catch(e){ console.error('Param-Parse error', e); kv = []; }

      const params = {};
      kv.forEach(o => params[o.key] = o.value);

      // 2) apiUrl aus Param lesen
      const apiUrl = params.apiUrl;
      if(!apiUrl){
        console.error('apiUrl fehlt');
        return;
      }

      // 3) Fetch-Techniker-Liste
      fetch(apiUrl)
        .then(r => r.json())
        .then(data => {
          const items = Array.isArray(data.items) ? data.items : [];
          const def   = params.default || '';
          const sel   = document.getElementById('techSelect');
          sel.innerHTML = '';
          items.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name; opt.textContent = name;
            if(name === def) opt.selected = true;
            sel.appendChild(opt);
          });
          function send(){ JFCustomWidget.sendData({value: sel.value}); }
          sel.addEventListener('change', send);
          send();
        })
        .catch(err => {
          console.error('Fetch error', err);
          document.getElementById('techSelect').innerHTML =
            '<option value="" disabled>Fehler beim Laden</option>';
        });

      // 4) iFrame Höhe anpassen
      JFCustomWidget.subscribe('ready', () => {
        JFCustomWidget.setHeight(document.body.scrollHeight);
      });
    })();
  </script>
</body>
</html>
